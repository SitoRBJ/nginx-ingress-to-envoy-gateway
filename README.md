# Ingress Migration — Nginx Ingress to Envoy Gateway

Go tool that migrates **Kubernetes Ingress** resources (Nginx controller) to **Envoy Gateway** manifests (HTTPRoute, SecurityPolicy, BackendTLSPolicy), so you can adopt the standard Gateway API without rewriting everything by hand.

## Features

- **Read from cluster**: Fetches existing Ingress via Kubernetes API (no need to export YAML by hand).
- **Gateway mapping**: Maps each `ingressClassName` to an Envoy Gateway (name, namespace, GatewayClass).
- **OAuth/OIDC**: Translates auth annotations (auth-url, auth-signin, auth-snippet) to SecurityPolicy with OIDC providers configurable per environment.
- **Common annotations**: rewrite-target, CORS, timeouts, body-size, redirects, canary, backend-protocol, etc.
- **Backend TLS**: Generates BackendTLSPolicy for HTTPS backends.
- **Output structure**: Writes files organized by namespace/service (e.g. `environments/<namespace>/<service>/templates/`).

## Requirements

- **Go 1.21+**
- **kubectl** and access to a Kubernetes cluster (kubeconfig configured).
- Existing Ingress resources using Nginx Ingress Controller annotations.

## Installation

```bash
git clone https://github.com/your-username/ingress-migration.git
cd ingress-migration
go mod download
go build -o migrate_ingress .
```

The `migrate_ingress` binary is created in the current directory. Optionally:

```bash
# Install into PATH (example)
go install .
# or
sudo cp migrate_ingress /usr/local/bin/
```

## Configuration

1. Copy the example file and edit it for your environment:

```bash
cp migrate-ingress-config.example.yaml migrate-ingress-config.yaml
```

> **Note:** The repo only includes `migrate-ingress-config.example.yaml`. Do not push `migrate-ingress-config.yaml` if it contains `client_id`, secrets, or other sensitive data.

2. Adjust at least:

- **`gateway_mapping`**: Keys must match `spec.ingressClassName` in your Ingress resources. Values are the Envoy Gateway to use (name, namespace, gatewayClass).
- **`oauth_config`**: If you use OAuth, define clusters (e.g. `dev`, `staging`, `prod`) and in each the secret with OIDC credentials and providers (issuer, client_id, scopes, etc.).
- **`backend_tls_policies`**: Only if you have HTTPS backends; key `"namespace/service:port"` and hostname/CA secret.

The file `migrate-ingress-config.example.yaml` is commented and serves as a generic template for any use case.

### Minimal `gateway_mapping` example

```yaml
gateway_mapping:
  internal:
    gateway_name: "envoy-gateway-internal"
    gateway_namespace: "gateway-system"
    gateway_class: "envoy-internal"

  public:
    gateway_name: "envoy-gateway-public"
    gateway_namespace: "gateway-system"
    gateway_class: "envoy-public"
```

If your Ingress resources use `ingressClassName: internal` or `ingressClassName: public`, the tool will generate HTTPRoutes that reference these Gateways.

### `oauth_config` example (single environment)

```yaml
oauth_config:
  dev:
    secret_name: "envoy-oidc-credentials"
    secret_namespace: "gateway-system"
    oidc_providers:
      google:
        issuer: "https://accounts.google.com"
        client_id: "YOUR_CLIENT_ID.apps.googleusercontent.com"
        scopes: ["openid", "email", "profile"]
        logout_path: "/logout"
        refresh_token: true
```

The value `dev` is the “cluster” name you pass with `--cluster dev` when running the tool.

## Usage

Basic syntax:

```bash
./migrate_ingress --namespace <namespace> --cluster <cluster> --config <config.yaml> [--kube-context <context>] [--output <dir>]
```

| Flag | Required | Description |
|------|----------|-------------|
| `--namespace` | Yes | Namespace to read Ingress from. |
| `--cluster` | Yes | Logical environment name (must exist in `oauth_config` if using OAuth). |
| `--config` | Yes | Path to config YAML (e.g. `migrate-ingress-config.yaml`). |
| `--kube-context` | No | kubectl context to use. Defaults to current. |
| `--output` | No | Base directory for generated manifests. Defaults to current directory (and structure in `output_structure`). |

### Full examples

Migrate all Ingress in namespace `default` with context `minikube`, using default config and cluster `dev`:

```bash
./migrate_ingress \
  --namespace default \
  --cluster dev \
  --config migrate-ingress-config.yaml \
  --kube-context minikube
```

Migrate namespace `my-app` for environment `staging` and write output to `./generated`:

```bash
./migrate_ingress \
  --namespace my-app \
  --cluster staging \
  --config migrate-ingress-config.yaml \
  --output ./generated
```

Run without installing (with `go run`):

```bash
go run . --namespace default --cluster prod --config migrate-ingress-config.yaml
```

## Output structure

With `output_structure.auto_detect_structure: true` (default in the example), files are generated by namespace and Ingress/service name, e.g.:

```
environments/
  default/
    my-service/
      templates/
        httproute.yaml
        securitypolicy.yaml   # if OAuth applies
        backendtlspolicy.yaml # if HTTPS backend applies
```

Each Ingress produces one or more HTTPRoute (and optionally SecurityPolicy and BackendTLSPolicy) in the corresponding folder.

## Recommended workflow

1. Set up `migrate-ingress-config.yaml` from `migrate-ingress-config.example.yaml`.
2. Try with a small namespace:  
   `./migrate_ingress --namespace <ns> --cluster <cluster> --config migrate-ingress-config.yaml --output ./test-output`
3. Review the generated YAML in `test-output` (or under `environments/` if you don’t use `--output`).
4. Adjust Gateway/OAuth/backend TLS in the config if something doesn’t match your environment.
5. Apply resources with `kubectl apply -f ...` when satisfied (ideally on a test cluster first).

## Supported annotations (summary)

- **OAuth**: `auth-url`, `auth-signin`, `auth-snippet` → SecurityPolicy with OIDC.
- **Routes and redirect**: `rewrite-target`, `permanent-redirect`, `force-ssl-redirect`, `ssl-redirect`.
- **CORS**: `enable-cors`, `cors-allow-origin`, `cors-allow-methods`, `cors-allow-headers`, `cors-allow-credentials`, `cors-max-age`.
- **Proxy**: `proxy-body-size`, `backend-protocol`, `proxy-connect-timeout`, `proxy-read-timeout`, `proxy-send-timeout`.
- **Canary**: `canary`, `canary-by-header`, `canary-by-header-value`, `canary-weight`.
- **Load balancing**: `load-balance`.

Paths listed in `excluded_auth_paths` (e.g. `/health`, `/metrics`) are generated as rules without OAuth.

## Contributing

Contributions are welcome: issues, documentation improvements, or support for more annotations/Envoy Gateway resources. Open an issue or Pull Request in the repository.
